---
title: "Querying UniChem with AnnotationGx"
author:
  - "Shahzada Muhammad Shameel Farooq"
  - "Christopher Eeles"
package: AnnotationGx
output: BiocStyle::html_document
bibliography: AnnotationGx.bib
vignette: >
  %\VignetteIndexEntry{Querying UniChem with AnnotationGx}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>


```{r load_pkg_eval, eval=TRUE, echo=FALSE}
library(AnnotationGx)
```

```{r capture_function_help, eval=TRUE, echo=FALSE}
# construct the function documentation text
qUniChem <- help(queryUniChem, package=AnnotationGx)
qUniChemTxt <- capture.output(tools::Rd2txt(utils:::.getHelpFile(as.character(qUniChem))))
qUniChemTxtClean <- gsub("_\b", "", qUniChemTxt)
dropAfter <- which(grepl("Details", qUniChemTxtClean))
qUniChemTxtCleanTrunc <- qUniChemTxtClean[1:(dropAfter - 1)]
```

# Introduction to the Unichem API

The UniChem database provides a publicly available REST API for
programmatic retrieval of mappings from standardized structural compound
identifiers to unique compound IDs across a range of large online
cheminformatic databases such as PubChem, ChEMBL, DrugBank and many more.
The service accepts POST requests to two different end-points:
`/compound` and `/connectivity`. Both endpoints accept query parameters via the
POST body in JSON format. The `/compound` API returns exact matches for the
queried compound, while the `/connectivity` API uses layers of the International
Chemical Identifier (InChI) of the query compound to return exact matches as
well as structurally related compounds such as isomers, salts, ionizations
and more.
[@UniChemBeta; @chambersUniChemUnifiedChemical2013]

The functions in `AnnotationGx` have been designed to allow package users to
easily query UniChem resources without any pre-existing knowledge of
HTTP requests or the API specifications. In doing so we hope to provide an
R native interface for mapping between various cheminformatic databases,
accessible to anyone familar with using R functions!

# Query UniChem Function

The primary function for querying the UniChem API in `AnnotationGx` is
`queryUniChem`. Within the R terminal, you can consult the function documentation
by typing `?queryUniChem`. An excerpt from the function documentation is
displayed here for convenience:

```{r show_function_docs, echo=FALSE, eval=TRUE}
cat(paste0(qUniChemTxtCleanTrunc, collapse="\n"))
```

Before we start using the `queryUniChem` function we need to load `AnnotationGx`.

```{r load_pkg_example, eval=FALSE}
library(AnnotationGx)
```

# Available Databases

To see a table of database identifiers available via UniChem, you can call
the `getUniChemSources` function. By default, just the database names and UniChem
IDs are returned.

```{r get_sources_short_echo, echo=TRUE, eval=FALSE}
getUniChemSources()
```


```{r get_sources_short, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE}
DT::datatable(getUniChemSources(), filter="none",
  options=list(pageLength=5, searching=FALSE, dom='<"top" t><"bottom" p>', className='dt-left'))
```

For convenience, the same information is returned when `queryUniChem` is called
with no arguments: `queryUniChem()`.

If you need more information about the available sources, setting the `metadata`
paramater to `TRUE` will return descriptions of each database as well as a
wealth of other information.

```{r get_sources_long_echo, echo=TRUE, eval=FALSE}
getUniChemSources(metadata=TRUE)
```

```{r get_sources_long, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE}
DT::datatable(getUniChemSources(metadata=TRUE), filter="none",
  options=list(scrollX=TRUE, pageLength=3, searching=FALSE,
    dom='<"top" t><"bottom" p>', className="dt-left")
)
```

# Using the UniChem API

## Retreiving cross database identifiers from a structural identifier

The most reliable method for retrieving information from UniChem is by using
a structural identifier, if it is available in your compound annotations. This
is because structural identifiers tend to be more stable than database specific
idenifiers, which can evolve over time as database are updated with the most
recent compound information.

The simplest case is the InChIKey, which is just a unique hash computed from the
much longer full InChI string for that compound.

Below we will retrieve all available database identifiers for the anti-neoplastic
drugs Erlotinib and Paclitaxel. The returned table includes all available
identifiers, which columns indicating the source database. To get the identifier
for your target database, simply filter the results table via the `shortName`
or `longName` columns which indicate the source of each mapped identfier.

```{r from_inchikey_show, echo=TRUE, eval=FALSE}
inchikeys <- c("AAKJLRGGTJKAMG-UHFFFAOYSA-N", "BCFGMOOMADDAQU-UHFFFAOYSA-N")
queryUniChem(compound=inchikeys, type="inchikey")
```

```{r from_inchikey, eval=TRUE, echo=FALSE}
inchikeys <- c("AAKJLRGGTJKAMG-UHFFFAOYSA-N", "BCFGMOOMADDAQU-UHFFFAOYSA-N")
DT::datatable(queryUniChem(compound=inchikeys, type="inchikey"), filter="none",
  options=list(scrollX=TRUE, pageLength=3, searching=FALSE,
    dom='<"top" t><"bottom" p>', className="dt-left")
)
```

If one of your compound queries fails, the returned table will contain
`NA` values in all columns except the `compound` column, which identifies the
query compound each mapping row is for.

## Mapping between database identifiers

While structural identifiers are the preferred method for UniChem look-ups,
they are often unavailable in the compound annotations of published datasets.
Therefore, we need to utilize whichever standard database identifier the data
generators have included. Since PubChem is the most frequent standard identifier
included, we have make the defaults for cross database look-ups to use this
source.

Again, we will look up identfiers for Erlotinib and Paclitaxel, but this time
using their ChEMBL ids.

```{r from_chembl_show, echo=TRUE, eval=FALSE}
chembl_ids <- c("CHEMBL12", "CHEMBL11")
queryUniChem(compound=chembl_ids, type="sourceID", sourceID="chembl")
```

```{r from_chembl, echo=FALSE, eval=TRUE}
chembl_ids <- c("CHEMBL12", "CHEMBL11")
DT::datatable(
  queryUniChem(compound=chembl_ids, type="sourceID", sourceID="chembl"),
  filter="none",
  options=list(scrollX=TRUE, pageLength=3, searching=FALSE,
    dom='<"top" t><"bottom" p>', className="dt-left")
)
```

The same procedure applies for other database identifiers.

## Other lookup methods

It is also possible to look up compounds using the full InChI string or
their unique UniChem ID by changing the `type` argument. Details are available
in the function documentation: `?queryUniChem`.

## What if I only have compound names?

In this case, the UniChem API will not be able to help solve your annotation
issues. Instead you will need to attempt a name look up using one of the
UniChem databases to get a standard idenfier, then use that with the
`queryUniChem` function if you need additional idenfiers. We suggest using the
PubChem API via the `queryPubChem` function.
See `vignette("PubChemAPIQueries")` for a tutorial!

# References
