---
title: "Annotating Treatments Pipeline"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Annotating Treatments Pipeline}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# THIS VIGNETTE IS A WORK IN PROGRESS

## This is an example Pipeline to annotate treatments from the CTRP dataset. 

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(AnnotationGx)
```


### Example pipeline to annotate a dataseGSM1897356t
#TODO::incomplete

We will be working with some data from the GDSC and Cell Model Passports datasets 
for this vignette. The GDSC dataset contains information about the cell lines 
in the Genomics of Drug Sensitivity in Cancer (GDSC) project. The Cell Model
Passports dataset contains information about all the models in the the database.


The GDSC sampleMetadata contains two columns, `GDSC.Sample_Name` and `GDSC.COSMIC_ID`.
``` {r setup data}
data(GDSC_sampleMetadata)
data(gCSI_sampleMetadata)
data(CTRP_sampleMetadata)
data(CCLE_sampleMetadata)
```

``` {r setBPPARAM}
BPPARAM = BiocParallel::MulticoreParam(progressbar=T)
```

``` {r view_GDSC_sampleMetadata}

head(GDSC_sampleMetadata)
<!-- 
mapCell2Accession(
  GDSC_sampleMetadata$GDSC.Sample_Name[1:300],
  BPPARAM = BPPARAM
) -->
```

``` {r view_gCSI_sampleMetadata}

head(gCSI_sampleMetadata)

```

``` {r view_CTRP_sampleMetadata}

head(CTRP_sampleMetadata)
```

``` {r view_CCLE_sampleMetadata}

head(CCLE_sampleMetadata)
```


``` {r julia_mapping}

mapping <- c("BT20" = "BT-20", "BT474" = "BT-474", "BT549" = "BT-549", "CAL120" = "CAL-120", "CAL148" = "CAL-148", 
             "CAL51" = "CAL-51", "CAMA1" = "CAMA-1", "EFM19" = "EFM-19", "HDQP1" = "HDQ-P1", "HS578T" = "Hs 578T",
             "JIMT1" = "JIMT-1", "KPL1" = "KPL-1", "LY2" = "MCF-7/LY2", "MCF7" = "MCF-7", "MDAMB157" = "MDA-MB-157",
             "MDAMB175VII" = "MDA-MB-175-VII", "MDAMB231" = "MDA-MB-231", "MDAMB361" = "MDA-MB-361", 
             "MDAMB436" = "MDA-MB-436", "MDAMB468" = "MDA-MB-468", "MX1" = "MX-1", "SKBR3" = "SK-BR-3", 
             "SKBR5" = "SK-BR-5", "SKBR7" = "SK-BR-7", "SUM149" = "SUM149PT", "SUM159" = "SUM159PT", "T47D" = "T-47D",
             "UACC812" = "UACC-812", "ZR751" = "ZR-75-1")

result <- mapCell2Accession(names(mapping))

setkeyv(result, "query")
for(i in 1:length(mapping)){
  if(mapping[[i]] !=  result[names(mapping)[i], "cellLineName"]){
    print(sprintf("mapping failed. got: %s, expected: %s", result[names(mapping)[i], cellLineName], mapping[[i]]))
  }
}

```


``` {r testannato}
cell_lines_all <- data.table::fread("/home/bioinf/bhklab/jermiah/Bioconductor/AnnotationGx/inst/extdata/cell_annotation_all.csv")
setkeyv(test_dt, "unique.cellid")
test_dt <- cell_lines_all[, .(unique.cellid, Cellosaurus.Accession.id, CCLE.cellid)]

range <- 1:nrow(test_dt)
result <- test_dt[range, mapCell2Accession(unique.cellid)]

#merge  result["query"] on test_result["unique.cellid"] 
test_dt <- merge(test_dt, result, by.x = "unique.cellid", by.y = "query", all.x = T)


test_dt[!is.na(accession) & !is.na(Cellosaurus.Accession.id) & Cellosaurus.Accession.id != "" & Cellosaurus.Accession.id != accession]

test_dt[
  range & !is.na(Cellosaurus.Accession.id) & Cellosaurus.Accession.id != "" & Cellosaurus.Accession.id != accession, 
  .(unique.cellid, Cellosaurus.Accession.id, accession, cellLineName)
  ]

```



```  {r debug}
da()
mapCell2Accession("A-704", raw = F)
mapCell2Accession("F5", raw = F, parsed = T, keep_duplicates = T) 
name <- "F5"
responses_dt[["cellLineName"]] %like% name
responses_dt[matchNested("F5", responses_dt), ]

```